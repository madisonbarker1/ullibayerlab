// Initialization and Splitting Channels
open();
	filedir = getDirectory("image");
	filename=getTitle();
	selectImage(filename); 
	//close();
	filein=filedir+filename; 
	run("Set Scale...", "distance=0 known=0 pixel=1 unit=pixel");
	//open(filein);
	// orgstackID= getImageID; 
	// getDimensions(width,height,channels,slices,frames);
	// setLocation(50,50);
	//rootname = File.nameWithoutExtension; 
	fileNum = substring(filename,0,3);
	//print (rootname);
	//Zoom loaded image 

	//run("Fire"); // can be changed according to user preference


rename("Image");
run("Split Channels");

selectImage("C1-Image");
run("Duplicate...", "title=[camkii] duplicate");
selectImage("C1-Image");
run("Duplicate...", "title=[fill] duplicate");
selectImage("C2-Image");
run("Duplicate...", "title=[glun2b] duplicate");
selectImage("fill");
run("Stack to Images");
selectImage("camkii");
run("Stack to Images");
selectImage("glun2b");
run("Stack to Images");

// Output the number of slices
selectImage("C1-Image");
n = nSlices();


selectImage("C3-Image");
close();



for (i = 1; i <= n; i++) {
    // Initialize the original name variable
    originalName = "camkii-";
    
    if (i < 10) {
        originalName += "000" + i;
    } else if (i < 100) {
        originalName += "00" + i;
    } else if (i < 1000) {
        originalName += "0" + i;
    } else {
        originalName += i;
    }

    // Construct the new name by appending the slice number to the base name (removing leading zeros in a simple way)
    newName = "camkii-" + i;

    // Select the image with the original name
    selectImage(originalName);

    // Rename the selected image
    rename(newName);
}

// Loop through each slice
for (i = 1; i <= n; i++) {
    // Initialize the original name variable
    originalName = "glun2b-";
    
    // Add leading zeros manually based on the value of i
    if (i < 10) {
        originalName += "000" + i;
    } else if (i < 100) {
        originalName += "00" + i;
    } else if (i < 1000) {
        originalName += "0" + i;
    } else {
        originalName += i;
    }

    // Construct the new name by appending the slice number to the base name (removing leading zeros in a simple way)
    newName = "glun2b-" + i;

    // Select the image with the original name
    selectImage(originalName);

    // Rename the selected image
    rename(newName);
}

listlength = n

// Loop through the images and create ROIs
for (i = 1; i <= listlength; i++) {
    imageName = "fill-";
    if (i < 10) {
        imageName += "000" + i;
    } else {
        imageName += "00" + i;
    }

    selectImage(imageName);
/*//right here is where you can change the thresholding to whatever you want it was the following before this new iteration of code
run("Subtract Background...", "rolling=50 stack");
// Apply a Gaussian blur to smooth the image.
run("Gaussian Blur...", "sigma=4 stack");
// Enhance the contrast of the image.
run("Enhance Contrast...", "saturated=0.3 process_all use");
*/

// Threshold the image - Use the threshold bar to adjust the threshold such that the entire cell is being thresholded for analysis.
run("Threshold...");
     getStatistics(area, mean, min, max, stdDev, histogram);
    thresholdValue = mean;
    setThreshold(thresholdValue, max);

    run("Create Selection");
    if (selectionType() >= 0) {
        roiManager("Add");
        roiManager("Select", roiManager("count")-1); // Selects the last added ROI
        roiManager("Rename", "CellArea" + i); // Normal ROI
    } else {
        print("No valid selection for " + imageName + ", adding dummy ROI.");
        makeRectangle(0, 0, 1, 1); // Create a tiny ROI at the corner of the image
        roiManager("Add");
        roiManager("Select", roiManager("count")-1); // Selects the last added ROI
        roiManager("Rename", "DummyCCellArea" + i); // Naming the dummy ROI distinctly
    }
}

// Save ROIs
roiManager("Deselect");
roiManager("Save", filedir + fileNum + "CellArea_ROIset.zip");

if (roiManager("count") > 0) {
    for (i = 0; i < roiManager("count"); i++) {
        roiManager("select", i);
       
        run("Coloc 2", "channel_1=camkii-" + ("000" + i+1) + " channel_2=glun2b-" + ("000" + i+1) + " roi_or_mask=[ROI Manager] threshold_regression=Costes display_images_in_result 2d_intensity_histogram psf=3 costes_randomisations=1");
    }
}

if (isOpen("Log")) {
    selectWindow("Log");

    // Construct the full file path and print it for verification
    filePath = filedir + fileNum + "PearsonCorrelation_results.txt";
    print("Saving log to: " + filePath);

    // Save the log contents
    saveAs("Text", filePath);
} else {
    print("Log window is not open.");
}

roiManager("Deselect");
roiManager("Delete");
run("Close All");
