#R Code for Condensate File Manipulation including an output file for Prism -- this is the 3 channel code
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(openxlsx)

main_dir <- "C:/Users/Chase/OneDrive/Documents/Bayer Lab Raw Data/HEK_CONDENSATES/GFP/mTq-WTtruncmonCaMKII monohub-YFP mScar-WT2bc 2 iono egta/Cells/Cells_analysis"

# Get a list of all subfolders in the main directory
subfolders <- list.dirs(main_dir, full.names = TRUE, recursive = FALSE)

# Create a new workbook
workbook <- createWorkbook()

process_files <- function(folder_path) {
  folder_name <- basename(folder_path)
  prefix <- substr(folder_name, 1, 3)
  
  # Define the paths to the different data files
  glun2bcell_area_file = file.path(folder_path, paste0(prefix, "GluN2BCellArea_results.csv"))
  camkiicell_area_file = file.path(folder_path, paste0(prefix, "CaMKIICellArea_results.csv"))
  hubcell_area_file = file.path(folder_path, paste0(prefix, "HubCellArea_results.csv"))
  glun2b_puncta_file = file.path(folder_path, paste0(prefix, "GluN2BPunctaArea_results.csv"))
  camkii_puncta_file = file.path(folder_path, paste0(prefix, "CaMKIIPunctaArea_results.csv"))
  hub_puncta_file = file.path(folder_path, paste0(prefix, "HubPunctaArea_results.csv"))
  
  # Load and check all files
  if (file.exists(glun2bcell_area_file) && file.exists(camkiicell_area_file) && file.exists(hubcell_area_file) &&
      file.exists(glun2b_puncta_file) && file.exists(camkii_puncta_file) && file.exists(hub_puncta_file)) {
    
    glun2b_cell_area <- read_csv(glun2bcell_area_file)
    camkii_cell_area <- read_csv(camkiicell_area_file)
    hub_cell_area <- read_csv(hubcell_area_file)
    glun2b_puncta <- read_csv(glun2b_puncta_file)
    camkii_puncta <- read_csv(camkii_puncta_file)
    hub_puncta <- read_csv(hub_puncta_file)
    
    # Calculate ratios
    ratios <- data.frame(Index = 1:nrow(glun2b_cell_area),
                         glun2b_puncta_intensity = glun2b_puncta$RawIntDen / glun2b_cell_area$RawIntDen,
                         CaMKII_puncta_intensity = camkii_puncta$RawIntDen / camkii_cell_area$RawIntDen,
                         hub_puncta_intensity = hub_puncta$RawIntDen / hub_cell_area$RawIntDen)
    
    # Convert from long to wide format for plotting and Excel
    ratios_long <- pivot_longer(ratios, cols = -Index, names_to = "Variable", values_to = "Value")
    plot <- ggplot(ratios_long, aes(x = Index, y = Value, color = Variable)) +
      geom_line() +
      labs(title = "Puncta Ratios", x = "Data Point Index", y = "Ratio") +
      theme_minimal()
    print(plot)
    
    # Add worksheet and write data
    sheet_name <- paste(folder_name, "puncta_ratios", sep = "_")
    addWorksheet(workbook, sheet_name)
    writeData(workbook, sheet_name, ratios)
    
    cat("Processed folder:", folder_path, "\n")
  } else {
    cat("Some files are missing in folder:", folder_path, "\n")
  }
}

# Apply the function to all subfolders
lapply(subfolders, process_files)

# Save the workbook
saveWorkbook(workbook, file.path(main_dir, "Results_Workbook.xlsx"), overwrite = TRUE)
cat("All data has been saved to Excel workbook.\n")
